# qcd
# Quickly `cd` into some frequently accessed project directories

XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-"${HOME}/.config"}
QCD_CONFIG_DIR=${QCD_CONFIG_DIR:-"${XDG_CONFIG_HOME}/qcd"}
QCD_DATABASE_FILE=${QCD_DATABASE_FILE:-"${QCD_CONFIG_DIR}/database"}


function print_usage () {
		cat 1>&2 <<__EOF__
Usage:
	qcd SHORTCUT
	qcd -acrh SHORTCUT [PATH]

	The first call changes to the directory specified by SHORTCUT.
	The second allows manipulation of the shortcut database.

	-a	Add a new shortcut pointing to PATH
	-c	Change an existing shortcut to PATH
	-r	Remove SHORTCUT
	-h	Display this help
__EOF__
}

function setup () {
	mkdir -p $QCD_CONFIG_DIR
	touch $QCD_DATABASE_FILE
}

function absolute_path () {
	(cd "$(dirname "$1")" && printf "%s/%s\n" "$(pwd)" "$(basename "$1")")
}

function shortcut_exists () {
	local shortcut=$1
	return $(awk '{ print $1 }' $QCD_DATABASE_FILE | grep "^${shortcut}$" >/dev/null 2>&1; echo $?)
}

function add_shortcut () {
	local shortcut=$1
	local path=$2

	# Don't add the shortcut if it already exists
	if ! shortcut_exists $shortcut; then
		path=$(absolute_path "$path")
		echo "${shortcut}	${path}" >> $QCD_DATABASE_FILE
	fi
}

function change_shortcut () {
	local shortcut=$1
	local path=$2

	if shortcut_exists $shortcut; then
		path=$(absolute_path "$path")

		# The `//\//\/` escapes slashes in the path so that `sed` doesn't complain
		sed -i.bak -E "s/^${shortcut}	.+$/${shortcut}	${path//\//\/}/" $QCD_DATABASE_FILE
	fi
}

function remove_shortcut () {
	local shortcut=$1

	if shortcut_exists $shortcut; then
		sed -i.bak -E "/^${shortcut}	.+/d" $QCD_DATABASE_FILE
	fi
}

function change_directory () {
	local shortcut=$1

	if shortcut_exists $shortcut; then
		local directory=$(awk -v shortcut="$shortcut" '{
			if ($1 == shortcut)
				{ sub(/[[:space:]]*([^[:space:]]+[[:space:]]+)/,""); print }
		}' $QCD_DATABASE_FILE)

		cd "$directory"
	fi
}

function qcd () {
	if [[ $# < 1 ]]; then
		print_usage
		return
	fi

	setup

	local command=$1
	local shortcut=$2
	local path=$3

	case $command in
		-a)
			add_shortcut $shortcut "$path"
			;;
		-c)
			change_shortcut $shortcut "$path"
			;;
		-r)
			remove_shortcut $shortcut
			;;
		-h|--help)
			print_usage
			;;
		*)
			change_directory $command
			;;
	esac
}

 # vim:ft=sh:
